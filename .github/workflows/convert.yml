name: Auto Convert Images to WebP + JSON + Cover

on:
  push:
    paths:
      - "upload/**"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install WebP tools
        run: sudo apt-get update && sudo apt-get install -y webp jq

      - name: Convert images safely
        run: |
          echo "Converting images to WebP..."
          find upload -type f \( \
            -iname "*.jpg" -o \
            -iname "*.jpeg" -o \
            -iname "*.png" -o \
            -iname "*.webp" -o \
            -iname "*.avif" \
          \) ! -name ".gitkeep" | while read file; do
            
            # Determine folder paths
            rel_dir=${file#upload/}
            rel_dir=$(dirname "$rel_dir")
            
            # Check if this is a cover
            base_name=$(basename "$file")
            if [ "$base_name" = "cover"* ]; then
              target="comic/$rel_dir"
              mkdir -p "$target"
              cwebp -q 80 "$file" -o "$target/cover.webp"
              rm "$file"
              continue
            fi
            
            # Normal episode images
            target="comic/$rel_dir"
            mkdir -p "$target"
            name_no_ext="${base_name%.*}"
            cwebp -q 80 "$file" -o "$target/$name_no_ext.webp"
            rm "$file"
          done

      - name: Rename WebP files sequentially
        run: |
          find comic -type d -name "episode-*" | while read dir; do
            count=1
            find "$dir" -maxdepth 1 -type f -iname "*.webp" | sort | while read img; do
              printf -v new "%03d.webp" $count
              mv "$img" "$dir/$new"
              count=$((count+1))
            done
          done

      - name: Add .gitkeep to empty folders
        run: |
          find comic -type d | while read dir; do
            if [ -z "$(ls -A "$dir" | grep -v '.gitkeep')" ]; then
              touch "$dir/.gitkeep"
            fi
          done

      - name: Generate JSON metadata for episodes
        run: |
          find comic -type d -name "episode-*" | while read epdir; do
            comic=$(echo "$epdir" | cut -d'/' -f2)
            season=$(echo "$epdir" | cut -d'/' -f3 | sed 's/season-//')
            episode=$(echo "$epdir" | cut -d'/' -f4 | sed 's/episode-//')
            
            json_file="$epdir/episode.json"
            
            echo "{" > $json_file
            echo "  \"comic\": \"$comic\"," >> $json_file
            echo "  \"season\": $season," >> $json_file
            echo "  \"episode\": $episode," >> $json_file
            echo "  \"imageCount\": $(find "$epdir" -maxdepth 1 -type f -iname "*.webp" | wc -l)," >> $json_file
            echo "  \"images\": [" >> $json_file
            find "$epdir" -maxdepth 1 -type f -iname "*.webp" | sort | while read img; do
              url="https://cdn.spineassociation.in/${img#comic/}"
              echo "    \"$url\"," >> $json_file
            done
            sed -i '$ s/,$//' $json_file
            echo "  ]" >> $json_file
            echo "}" >> $json_file
          done

      - name: Commit changes
        run: |
          git config user.name "PrithviRajSanotiya"
          git config user.email "PrithviRajSanotiya@users.noreply.github.com"
          git add comic
          git commit -m "Auto convert images + generate JSON + cover" || echo "No changes"
          git push
