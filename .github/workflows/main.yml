name: Auto Convert Images & PDFs to WebP + JSON + Covers

on:
  push:
    paths:
      - "upload/**"

# üîë FIX: This is required to allow the bot to push changes back to your repo
permissions:
  contents: write

jobs:
  convert_and_commit:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y webp jq poppler-utils git imagemagick
          # Unlock PDF processing in ImageMagick
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml || true

      # 3Ô∏è‚É£ Process uploads (Covers, PDFs, all images)
      - name: Process uploads
        run: |
          echo "Processing uploaded files..."
          # Using -print0 to handle filenames with spaces correctly
          find upload -type f ! -name ".gitkeep" -print0 | while IFS= read -r -d '' file; do
            rel_dir=$(dirname "${file#upload/}")
            target="comic/$rel_dir"
            mkdir -p "$target"
            
            base_name=$(basename "$file")
            ext="${base_name##*.}"
            ext_lc=$(echo "$ext" | tr '[:upper:]' '[:lower:]')

            # --- YOUR COVER LOGIC ---
            if [[ "$base_name" =~ ^cover.*\.(pdf|jpg|jpeg|png|webp|avif)$ ]]; then
              if [[ "$ext_lc" == "pdf" ]]; then
                pdftoppm -png "$file" "$target/temp_cover" -f 1 -singlefile
                cwebp -q 80 "$target/temp_cover.png" -o "$target/cover.webp"
                rm "$target/temp_cover.png"
              else
                cwebp -q 80 "$file" -o "$target/cover.webp" || convert "$file" "$target/cover.webp"
              fi
              rm "$file"
              continue
            fi

            # --- YOUR EPISODE PDF LOGIC ---
            if [[ "$ext_lc" == "pdf" ]]; then
              pdftoppm -png "$file" "$target/page"
              rm "$file"
              for img in "$target"/page-*.png; do
                [ -e "$img" ] || continue
                cwebp -q 80 "$img" -o "${img%.png}.webp"
                rm "$img"
              done
              continue
            fi

            # --- YOUR IMAGE TYPES LOGIC ---
            if [[ "$ext_lc" =~ ^(jpg|jpeg|png|webp|avif)$ ]]; then
              cwebp -q 80 "$file" -o "$target/${base_name%.*}.webp" 2>/dev/null || convert "$file" "$target/${base_name%.*}.webp"
            else
              convert "$file" "$target/${base_name%.*}.webp"
            fi
            rm "$file"
          done

      # 4Ô∏è‚É£ YOUR Sequential Rename Logic
      - name: Rename WebP files sequentially
        run: |
          find comic -type d -name "episode-*" | while read -r dir; do
            count=1
            find "$dir" -maxdepth 1 -type f -iname "*.webp" ! -name "cover.webp" | sort -V | while read -r img; do
              printf -v new "%03d.webp" $count
              mv "$img" "$dir/$new"
              count=$((count+1))
            done
          done

      # 5Ô∏è‚É£ Add .gitkeep to empty folders
      - name: Add .gitkeep to empty folders
        run: |
          find comic -type d -empty -exec touch {}/.gitkeep \;
          find upload -type d -empty -exec touch {}/.gitkeep \;

      # 6Ô∏è‚É£ YOUR JSON Metadata Logic
      - name: Generate JSON metadata for episodes
        run: |
          find comic -type d -name "episode-*" | while read -r epdir; do
            comic=$(echo "$epdir" | cut -d'/' -f2)
            season=$(echo "$epdir" | cut -d'/' -f3 | sed 's/season-//')
            episode=$(echo "$epdir" | cut -d'/' -f4 | sed 's/episode-//')
            
            json_file="$epdir/episode.json"
            
            echo "{" > "$json_file"
            echo "  \"comic\": \"$comic\"," >> "$json_file"
            echo "  \"season\": ${season:-0}," >> "$json_file"
            echo "  \"episode\": ${episode:-0}," >> "$json_file"
            echo "  \"imageCount\": $(find "$epdir" -maxdepth 1 -type f -iname "*.webp" ! -name "cover.webp" | wc -l)," >> "$json_file"
            echo "  \"images\": [" >> "$json_file"
            
            # Proper JSON array formatting
            find "$epdir" -maxdepth 1 -type f -iname "*.webp" ! -name "cover.webp" | sort -V | sed '$!s/$/,/' | while read -r img; do
              url="https://cdn.spineassociation.in/${img#comic/}"
              echo "    \"$url\"" >> "$json_file"
            done
            echo "  ]" >> "$json_file"
            echo "}" >> "$json_file"
          done

      # 7Ô∏è‚É£ Consolidated Commit (Fixes the 403 and Double Push error)
      - name: Commit and Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add comic/
          git add upload/
          
          if ! git diff --cached --quiet; then
            git commit -m "Auto: processed uploads $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit"
          fi
